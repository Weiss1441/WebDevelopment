<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tasks</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>

<nav>
  <a href="/">Home</a> |
  <a href="/tasks">Tasks</a> |
  <a href="/login" id="loginLink">Login</a>
  <button id="logoutBtn" style="display:none; margin-left:10px;">Logout</button>
</nav>

<div class="container">
  <h1>Task Management</h1>
  <div id="message" style="display:none;"></div>

  <h2 id="form-title">Create New Task</h2>

  <form id="taskForm">
    <input type="hidden" id="taskId" />

    <label>Title</label>
    <input type="text" id="title" required />

    <label>Details</label>
    <textarea id="details" required></textarea>

    <label>Status</label>
    <select id="status">
      <option value="todo">Todo</option>
      <option value="inprogress">In Progress</option>
      <option value="done">Done</option>
    </select>

    <label>Priority</label>
    <select id="priority">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="high">High</option>
    </select>

    <label>Category</label>
    <select id="category">
      <option value="study">Study</option>
      <option value="work">Work</option>
      <option value="personal">Personal</option>
      <option value="health">Health</option>
      <option value="finance">Finance</option>
      <option value="shopping">Shopping</option>
      <option value="other">Other</option>
    </select>

    <label>Deadline</label>
    <input type="date" id="deadline" />

    <button type="submit" id="submitBtn">Create Task</button>
    <button type="button" id="cancelBtn" style="display:none;">Cancel</button>
  </form>

  <hr />

  <h2>Filter & Sort</h2>

  <label>Filter by title (STRICT)</label>
  <input type="text" id="filterTitle" placeholder="Exact title match..." />

  <label>Sort</label>
  <select id="sortBy">
    <option value="">None</option>
    <option value="title">Title A → Z</option>
    <option value="-title">Title Z → A</option>
    <option value="-createdAt">Newest first</option>
    <option value="createdAt">Oldest first</option>
    <option value="deadline">Deadline soonest</option>
    <option value="-deadline">Deadline latest</option>
    <option value="priority">Priority (A→Z)</option>
    <option value="-priority">Priority (Z→A)</option>
  </select>

  <button id="applyFilter" type="button">Apply</button>
  <button id="resetFilter" type="button" style="margin-left:8px;">Reset</button>

  <hr />

  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <h2 style="margin:0;">All Tasks</h2>
    <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
      <button id="prevBtn" type="button">Prev</button>
      <span id="pageInfo">Page 1 / 1</span>
      <button id="nextBtn" type="button">Next</button>
    </div>
  </div>

  <div id="tasksList"></div>
</div>

<script>
let isAuthed = false;
let isAdmin = false;
let editMode = false;

let page = 1;
let totalPages = 1;
const limit = 10;

const loginLink = document.getElementById('loginLink');
const logoutBtn = document.getElementById('logoutBtn');
const tasksList = document.getElementById('tasksList');

const taskForm = document.getElementById('taskForm');
const taskIdEl = document.getElementById('taskId');
const titleEl = document.getElementById('title');
const detailsEl = document.getElementById('details');
const statusEl = document.getElementById('status');
const priorityEl = document.getElementById('priority');
const categoryEl = document.getElementById('category');
const deadlineEl = document.getElementById('deadline');
const cancelBtn = document.getElementById('cancelBtn');
const formTitle = document.getElementById('form-title');

const filterTitleEl = document.getElementById('filterTitle');
const sortByEl = document.getElementById('sortBy');

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageInfo = document.getElementById('pageInfo');

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text || '';
  return div.innerHTML;
}

async function fetchJson(url, options) {
  const res = await fetch(url, options);
  const data = await res.json().catch(() => null);
  if (!res.ok) throw new Error(data?.error || 'request failed');
  return data;
}

function updatePager() {
  if (totalPages < 1) totalPages = 1;
  if (page < 1) page = 1;
  if (page > totalPages) page = totalPages;

  pageInfo.textContent = `Page ${page} / ${totalPages}`;
  prevBtn.disabled = !isAuthed || page <= 1;
  nextBtn.disabled = !isAuthed || page >= totalPages;
}

async function checkAuth() {
  try {
    const me = await fetchJson('/api/auth/me');
    isAuthed = me.authenticated;
    isAdmin = me.role === 'admin';

    loginLink.style.display = isAuthed ? 'none' : 'inline';
    logoutBtn.style.display = isAuthed ? 'inline-block' : 'none';

    Array.from(taskForm.elements).forEach(el => el.disabled = !isAuthed);
  } catch {
    isAuthed = false;
    isAdmin = false;
  }
  updatePager();
}

async function loadTasks() {
  if (!isAuthed) return;

  const base = isAdmin ? '/api/admin/tasks' : '/api/tasks';

  const title = filterTitleEl.value.trim();
  const sort = sortByEl.value;

  const params = [];
  if (title) params.push(`title=${encodeURIComponent(title)}`);
  if (sort) params.push(`sort=${encodeURIComponent(sort)}`);
  params.push(`page=${encodeURIComponent(page)}`);
  params.push(`limit=${encodeURIComponent(limit)}`);

  const url = base + `?${params.join('&')}`;

  const data = await fetchJson(url);
  const tasks = Array.isArray(data) ? data : (data.items || []);
  totalPages = Array.isArray(data) ? 1 : (data.totalPages || 1);

  updatePager();

  tasksList.innerHTML = '';

  if (!tasks.length) {
    tasksList.innerHTML = '<p>No tasks</p>';
    return;
  }

  tasks.forEach(t => {
    const div = document.createElement('div');
    div.className = 'note-item';

    const dl = t.deadline ? new Date(t.deadline) : null;
    const dlText = (dl && !isNaN(dl.getTime())) ? dl.toLocaleDateString() : '—';

    div.innerHTML = `
      <h3>${escapeHtml(t.title)}</h3>
      <p>${escapeHtml(t.details)}</p>
      <p><b>Status:</b> ${escapeHtml(t.status)}</p>
      <p><b>Priority:</b> ${escapeHtml(t.priority)}</p>
      <p><b>Category:</b> ${escapeHtml(t.category)}</p>
      <p><b>Deadline:</b> ${escapeHtml(dlText)}</p>
      <div class="note-actions">
        <button>Edit</button>
        <button>Delete</button>
      </div>
    `;

    const [editBtn, delBtn] = div.querySelectorAll('button');

    editBtn.onclick = () => editTask(t);
    delBtn.onclick = () => deleteTask(t._id);

    tasksList.appendChild(div);
  });
}

function editTask(t) {
  editMode = true;
  taskIdEl.value = t._id;
  titleEl.value = t.title;
  detailsEl.value = t.details;
  statusEl.value = t.status;
  priorityEl.value = t.priority;
  categoryEl.value = t.category;
  deadlineEl.value = t.deadline ? String(t.deadline).slice(0,10) : '';

  formTitle.textContent = 'Edit Task';
  cancelBtn.style.display = 'inline-block';
}

cancelBtn.onclick = () => {
  editMode = false;
  taskForm.reset();
  taskIdEl.value = '';
  formTitle.textContent = 'Create New Task';
  cancelBtn.style.display = 'none';
};

function resetToFirstPage() {
  page = 1;
  totalPages = 1;
  updatePager();
}

taskForm.onsubmit = async (e) => {
  e.preventDefault();

  const data = {
    title: titleEl.value,
    details: detailsEl.value,
    status: statusEl.value,
    priority: priorityEl.value,
    category: categoryEl.value,
    deadline: deadlineEl.value || null
  };

  const id = taskIdEl.value;
  const base = isAdmin ? '/api/admin/tasks' : '/api/tasks';
  const url = editMode ? `${base}/${id}` : base;
  const method = editMode ? 'PUT' : 'POST';

  await fetchJson(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  editMode = false;
  taskForm.reset();
  cancelBtn.style.display = 'none';
  formTitle.textContent = 'Create New Task';

  resetToFirstPage();
  await loadTasks();
};

async function deleteTask(id) {
  if (!confirm('Delete task?')) return;

  const base = isAdmin ? '/api/admin/tasks' : '/api/tasks';
  await fetchJson(`${base}/${id}`, { method: 'DELETE' });

  await loadTasks();
}

document.getElementById('applyFilter').onclick = async () => {
  resetToFirstPage();
  await loadTasks();
};

document.getElementById('resetFilter').onclick = async () => {
  filterTitleEl.value = '';
  sortByEl.value = '';
  resetToFirstPage();
  await loadTasks();
};

prevBtn.onclick = async () => {
  if (page > 1) {
    page -= 1;
    await loadTasks();
  }
};

nextBtn.onclick = async () => {
  if (page < totalPages) {
    page += 1;
    await loadTasks();
  }
};

logoutBtn.onclick = async () => {
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/login';
};

document.addEventListener('DOMContentLoaded', async () => {
  await checkAuth();
  await loadTasks();
});
</script>

</body>
</html>
